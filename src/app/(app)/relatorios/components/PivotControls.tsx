// src/app/(app)/relatorios/components/PivotControls.tsx
"use client";

/**
 * ðŸ”„ PASSO 1 IMPLEMENTADO: CONFIGURAÃ‡ÃƒO COMPLETA DOS CAMPOS
 *
 * âœ… SINCRONIZADO COM QUERY SQL: Todos os 36 campos da query principal estÃ£o mapeados
 * âœ… DIMENSÃ•ES: 29 campos categÃ³ricos/textuais/datas disponÃ­veis para linhas e colunas
 * âœ… MÃ‰TRICAS: 7 campos numÃ©ricos disponÃ­veis para agregaÃ§Ã£o
 * âœ… TIPOS CORRETOS: Campos de data marcados como "date", numÃ©ricos como mÃ©tricas
 *
 * Query SQL de referÃªncia possui 36 campos:
 * - ID_DO_ITEM, GRUPO_DE_ESCRITORIO, GRUPO_MASTER, COMPRADOR, EMPRESA, FORNECEDOR,
 * - ID_COTACAO, NO_ERP, FAMILIA, FINALIZADA, COD_ITEM, DESCRICAO_RESUMIDA,
 * - DESCRICAO_COMPLETA, SOLICITANTE, MARCA, MARCA_SUGERIDA, QUANTIDADE,
 * - VALOR_UNIT_ULT_COMPRA, PRECO_NEGOCIADO, NO_CONTRATO, VALOR_TOTAL_NEGOCIADO,
 * - SAVING_ULT_COMPRA, SAVING_MELHOR_PRECO, ORDEM_COMPRA, PROJETO_RFA,
 * - CLASSIFICACAO, DATA_REQUISICAO, DATA_NECESSIDADE, SUBFAMILIA, NO_SOLICITACAO,
 * - CRITERIO, NCM, ESTIMATIVA_VALOR, UNID_MEDIDA, MOEDA, DEPARTAMENTO,
 * - APLICACAO, STATUS_PROCESSO, STATUS_ITEM, REQUISICAO_ERP
 */

import React from "react";
import {
  Box,
  Paper,
  Typography,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  Button,
  SelectChangeEvent,
  Chip,
  Autocomplete,
  TextField,
} from "@mui/material";
import {
  PivotConfiguration,
  DimensionOption,
  MetricOption,
  AggregationType,
} from "@/features/reports/types/pivot.types";

// OpÃ§Ãµes de dimensÃµes baseadas na sua query SQL - TODOS OS 36 CAMPOS
// Campos categÃ³ricos/textuais/datas (29 campos) - os 7 campos numÃ©ricos estÃ£o em METRIC_OPTIONS abaixo
const DIMENSION_OPTIONS: DimensionOption[] = [
  // Campos identificadores (9 campos)
  { value: "ID_DO_ITEM", label: "ID do Item", dataType: "string" },
  { value: "ID_COTACAO", label: "ID CotaÃ§Ã£o", dataType: "string" },
  { value: "NO_ERP", label: "NÂº ERP", dataType: "string" },
  { value: "COD_ITEM", label: "CÃ³digo Item", dataType: "string" },
  { value: "NO_CONTRATO", label: "NÂº Contrato", dataType: "string" },
  { value: "NO_SOLICITACAO", label: "NÂº SolicitaÃ§Ã£o", dataType: "string" },
  { value: "ORDEM_COMPRA", label: "Ordem Compra", dataType: "string" },
  { value: "PROJETO_RFA", label: "Projeto RFA", dataType: "string" },
  { value: "REQUISICAO_ERP", label: "RequisiÃ§Ã£o ERP", dataType: "string" },

  // Campos organizacionais (4 campos)
  {
    value: "GRUPO_DE_ESCRITORIO",
    label: "Grupo de EscritÃ³rio",
    dataType: "string",
  },
  { value: "GRUPO_MASTER", label: "Grupo Master", dataType: "string" },
  { value: "EMPRESA", label: "Empresa", dataType: "string" },
  { value: "DEPARTAMENTO", label: "Departamento", dataType: "string" },

  // Pessoas (3 campos)
  { value: "COMPRADOR", label: "Comprador", dataType: "string" },
  { value: "SOLICITANTE", label: "Solicitante", dataType: "string" },
  { value: "FORNECEDOR", label: "Fornecedor", dataType: "string" },

  // DescriÃ§Ãµes do item (9 campos)
  {
    value: "DESCRICAO_RESUMIDA",
    label: "DescriÃ§Ã£o Resumida",
    dataType: "string",
  },
  {
    value: "DESCRICAO_COMPLETA",
    label: "DescriÃ§Ã£o Completa",
    dataType: "string",
  },
  { value: "FAMILIA", label: "FamÃ­lia", dataType: "string" },
  { value: "SUBFAMILIA", label: "SubfamÃ­lia", dataType: "string" },
  { value: "CLASSIFICACAO", label: "ClassificaÃ§Ã£o", dataType: "string" },
  { value: "NCM", label: "NCM", dataType: "string" },
  { value: "UNID_MEDIDA", label: "Unidade Medida", dataType: "string" },
  { value: "APLICACAO", label: "AplicaÃ§Ã£o", dataType: "string" },
  { value: "CRITERIO", label: "CritÃ©rio", dataType: "string" },

  // Marcas (2 campos)
  { value: "MARCA", label: "Marca", dataType: "string" },
  { value: "MARCA_SUGERIDA", label: "Marca Sugerida", dataType: "string" },

  // Status (2 campos)
  { value: "STATUS_PROCESSO", label: "Status Processo", dataType: "string" },
  { value: "STATUS_ITEM", label: "Status Item", dataType: "string" },

  // Outros (1 campo)
  { value: "MOEDA", label: "Moeda", dataType: "string" },

  // Campos de data (3 campos)
  { value: "FINALIZADA", label: "Data Finalizada", dataType: "date" },
  { value: "DATA_REQUISICAO", label: "Data RequisiÃ§Ã£o", dataType: "date" },
  { value: "DATA_NECESSIDADE", label: "Data Necessidade", dataType: "date" },
];

// OpÃ§Ãµes de mÃ©tricas (campos numÃ©ricos) - OS 7 CAMPOS NUMÃ‰RICOS DA QUERY SQL
const METRIC_OPTIONS: MetricOption[] = [
  {
    value: "QUANTIDADE",
    label: "Quantidade",
    aggregations: ["sum", "avg", "count", "max", "min"],
  },
  {
    value: "VALOR_UNIT_ULT_COMPRA",
    label: "Valor Unit. Ãšltima Compra",
    aggregations: ["sum", "avg", "count", "max", "min"],
  },
  {
    value: "PRECO_NEGOCIADO",
    label: "PreÃ§o Negociado",
    aggregations: ["sum", "avg", "count", "max", "min"],
  },
  {
    value: "VALOR_TOTAL_NEGOCIADO",
    label: "Valor Total Negociado",
    aggregations: ["sum", "avg", "count", "max", "min"],
  },
  {
    value: "SAVING_ULT_COMPRA",
    label: "Saving (Ãšltima Compra)",
    aggregations: ["sum", "avg", "count", "max", "min"],
  },
  {
    value: "SAVING_MELHOR_PRECO",
    label: "Saving (Melhor PreÃ§o)",
    aggregations: ["sum", "avg", "count", "max", "min"],
  },
  {
    value: "ESTIMATIVA_VALOR",
    label: "Estimativa Valor",
    aggregations: ["sum", "avg", "count", "max", "min"],
  },
];

// OpÃ§Ãµes de agregaÃ§Ã£o
const AGGREGATION_OPTIONS: { value: AggregationType; label: string }[] = [
  { value: "sum", label: "Soma" },
  { value: "avg", label: "MÃ©dia" },
  { value: "count", label: "Contagem" },
  { value: "max", label: "MÃ¡ximo" },
  { value: "min", label: "MÃ­nimo" },
];

interface PivotControlsProps {
  config: PivotConfiguration;
  onConfigChange: (config: PivotConfiguration) => void;
  onApplyPivot: () => void;
  loading: boolean;
}

export default function PivotControls({
  config,
  onConfigChange,
  onApplyPivot,
  loading,
}: PivotControlsProps) {
  const handleRowsChange = (newRows: string[]) => {
    onConfigChange({
      ...config,
      rows: newRows,
    });
  };

  const handleColumnsChange = (newColumns: string[]) => {
    onConfigChange({
      ...config,
      columns: newColumns,
    });
  };

  const handleValuesChange = (newValues: string[]) => {
    onConfigChange({
      ...config,
      values: newValues,
    });
  };

  const handleAggregationChange = (event: SelectChangeEvent) => {
    onConfigChange({
      ...config,
      aggregation: event.target.value as AggregationType,
    });
  };

  return (
    <Paper
      elevation={0}
      sx={{
        p: 3,
        mb: 3,
        backgroundColor: "grey.50",
        borderRadius: 2,
        border: "1px solid",
        borderColor: "grey.200",
      }}
    >
      <Typography
        variant="h6"
        gutterBottom
        sx={{ fontWeight: "bold", color: "primary.main" }}
      >
        ðŸ”„ ConfiguraÃ§Ã£o da Tabela DinÃ¢mica
      </Typography>

      <Box
        sx={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 3, mb: 3 }}
      >
        {/* Linhas */}
        <FormControl fullWidth>
          <Autocomplete
            multiple
            options={DIMENSION_OPTIONS.map((opt) => opt.value)}
            getOptionLabel={(option) =>
              DIMENSION_OPTIONS.find((opt) => opt.value === option)?.label ||
              option
            }
            value={config.rows}
            onChange={(_, newValue) => handleRowsChange(newValue)}
            renderTags={(value, getTagProps) =>
              value.map((option, index) => (
                <Chip
                  variant="outlined"
                  label={
                    DIMENSION_OPTIONS.find((opt) => opt.value === option)
                      ?.label || option
                  }
                  {...getTagProps({ index })}
                  key={option}
                />
              ))
            }
            renderInput={(params) => (
              <TextField
                {...params}
                label="Linhas"
                placeholder="Selecione campos para as linhas"
                variant="outlined"
              />
            )}
          />
        </FormControl>

        {/* Colunas */}
        <FormControl fullWidth>
          <Autocomplete
            multiple
            options={DIMENSION_OPTIONS.map((opt) => opt.value)}
            getOptionLabel={(option) =>
              DIMENSION_OPTIONS.find((opt) => opt.value === option)?.label ||
              option
            }
            value={config.columns}
            onChange={(_, newValue) => handleColumnsChange(newValue)}
            renderTags={(value, getTagProps) =>
              value.map((option, index) => (
                <Chip
                  variant="outlined"
                  label={
                    DIMENSION_OPTIONS.find((opt) => opt.value === option)
                      ?.label || option
                  }
                  {...getTagProps({ index })}
                  key={option}
                />
              ))
            }
            renderInput={(params) => (
              <TextField
                {...params}
                label="Colunas"
                placeholder="Selecione campos para as colunas"
                variant="outlined"
              />
            )}
          />
        </FormControl>
      </Box>

      <Box
        sx={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 3, mb: 3 }}
      >
        {/* Valores */}
        <FormControl fullWidth>
          <Autocomplete
            multiple
            options={METRIC_OPTIONS.map((opt) => opt.value)}
            getOptionLabel={(option) =>
              METRIC_OPTIONS.find((opt) => opt.value === option)?.label ||
              option
            }
            value={config.values}
            onChange={(_, newValue) => handleValuesChange(newValue)}
            renderTags={(value, getTagProps) =>
              value.map((option, index) => (
                <Chip
                  variant="outlined"
                  color="primary"
                  label={
                    METRIC_OPTIONS.find((opt) => opt.value === option)?.label ||
                    option
                  }
                  {...getTagProps({ index })}
                  key={option}
                />
              ))
            }
            renderInput={(params) => (
              <TextField
                {...params}
                label="Valores"
                placeholder="Selecione campos para agregaÃ§Ã£o"
                variant="outlined"
              />
            )}
          />
        </FormControl>

        {/* AgregaÃ§Ã£o */}
        <FormControl fullWidth>
          <InputLabel>Tipo de AgregaÃ§Ã£o</InputLabel>
          <Select
            value={config.aggregation}
            label="Tipo de AgregaÃ§Ã£o"
            onChange={handleAggregationChange}
          >
            {AGGREGATION_OPTIONS.map((option) => (
              <MenuItem key={option.value} value={option.value}>
                {option.label}
              </MenuItem>
            ))}
          </Select>
        </FormControl>
      </Box>

      <Box sx={{ display: "flex", justifyContent: "flex-end", gap: 2 }}>
        <Button
          variant="contained"
          onClick={onApplyPivot}
          disabled={loading || config.values.length === 0}
          sx={{ minWidth: 140 }}
        >
          {loading ? "Processando..." : "Gerar Tabela DinÃ¢mica"}
        </Button>
      </Box>

      {/* InstruÃ§Ãµes */}
      <Box sx={{ mt: 2, p: 2, backgroundColor: "info.light", borderRadius: 1 }}>
        <Typography variant="body2" color="info.contrastText">
          ðŸ’¡ <strong>Como usar:</strong> Selecione campos para{" "}
          <strong>Linhas</strong> e <strong>Colunas</strong>
          (dimensÃµes), escolha campos numÃ©ricos para <strong>
            Valores
          </strong>{" "}
          (mÃ©tricas) e defina o tipo de
          <strong> AgregaÃ§Ã£o</strong>. Em seguida, clique em &quot;Gerar Tabela
          DinÃ¢mica&quot;.
        </Typography>
      </Box>
    </Paper>
  );
}
